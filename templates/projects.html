<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projects</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    .action-btns button { margin-right: 5px; }
  </style>
</head>
<body>
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Projects</h3>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProjectModal">+ Add Project</button>
  </div>
  <table class="table table-bordered table-striped" id="projectsTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Enquiry ID</th>
        <th>Project</th>
        <th>Quotation</th>
        <th>Vendor</th>
        <th>Location</th>
        <th>Start</th>
        <th>End</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in projects %}
      <tr>
        <td>{{ p.id }}</td>
        <td>{{ p.enquiry_id }}</td>
        <td>{{ p.project_name }}</td>
        <td>{{ p.quotation_ro }}</td>
        <td>{{ p.vendor_name }}</td>
        <td>{{ p.location }}</td>
        <td>{{ p.start_date }}</td>
        <td>{{ p.end_date }}</td>
        <td class="action-btns">
          <button class="btn btn-success btn-sm" onclick="openSheet({{ p.id }})">Sheet</button>
          <button class="btn btn-warning btn-sm">Edit</button>
          <button class="btn btn-danger btn-sm">Delete</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <form id="projectForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Project</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-3">
        <div class="col-md-6">
          <label class="form-label">Enquiry ID</label>
          <input type="text" name="enquiry_id" class="form-control" value="{{ enquiry_id }}" readonly>
        </div>
        <div class="col-md-6">
          <label class="form-label">Project Name</label>
          <input type="text" name="project_name" class="form-control" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Quotation/RO</label>
          <input type="text" name="quotation_ro" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Location</label>
          <input type="text" name="location" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Start Date</label>
          <input type="date" name="start_date" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">End Date</label>
          <input type="date" name="end_date" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Vendor</label>
          <select name="vendor_id" id="vendorDropdown" class="selectpicker form-control" data-live-search="true" required>
            <option value="">Select Vendor</option>
            {% for v in vendors %}
              <option value="{{ v.id }}" data-gst="{{ v.gst_number }}" data-address="{{ v.address }}">{{ v.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Vendor GST</label>
          <input type="text" id="vendorGST" class="form-control" readonly>
        </div>
        <div class="col-md-12">
          <label class="form-label">Vendor Address</label>
          <input type="text" id="vendorAddress" class="form-control" readonly>
        </div>
        <div class="col-md-6">
          <label class="form-label">Incharge</label>
          <input type="text" name="incharge" class="form-control">
        </div>
        <div class="col-md-6">
          <label class="form-label">Contact Number</label>
          <input type="text" name="contact_number" class="form-control">
        </div>
        <div class="col-md-12">
          <label class="form-label">Email</label>
          <input type="email" name="email" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-primary">Save Project</button>
      </div>
    </form>
  </div>
</div>

<!-- Sheet Modal -->
<div class="modal fade" id="sheetModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-4">
      <h5>Measurement Sheet for Project ID: <span id="sheetProjectId"></span></h5>
      <p>(Measurement sheet popup content goes here...)</p>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="toast-success" class="toast align-items-center text-bg-success border-0">
    <div class="d-flex">
      <div class="toast-body">Project saved successfully!</div>
      <button type="button" class="btn-close btn-close-white ms-2 me-2" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<script>
  $(document).ready(function () {
    $('.selectpicker').selectpicker();

    $('#vendorDropdown').on('changed.bs.select', function () {
      const selected = $(this).find('option:selected');
      $('#vendorGST').val(selected.data('gst') || '');
      $('#vendorAddress').val(selected.data('address') || '');
    });

    $('#projectForm').submit(function (e) {
      e.preventDefault();
      $.post('/create_project', $(this).serialize(), function (res) {
        if (res.status === 'success') {
          const p = res.project;
          $('#projectsTable tbody').prepend(`
            <tr>
              <td>${p.id}</td>
              <td>${p.enquiry_id}</td>
              <td>${p.project_name}</td>
              <td>${p.quotation_ro || ''}</td>
              <td>${p.vendor_name}</td>
              <td>${p.location}</td>
              <td>${p.start_date || ''}</td>
              <td>${p.end_date || ''}</td>
              <td class="action-btns">
                <button class="btn btn-success btn-sm" onclick="openSheet(${p.id})">Sheet</button>
                <button class="btn btn-warning btn-sm">Edit</button>
                <button class="btn btn-danger btn-sm">Delete</button>
              </td>
            </tr>
          `);
          new bootstrap.Toast(document.getElementById('toast-success')).show();
          $('#projectForm')[0].reset();
          $('.selectpicker').selectpicker('refresh');
          $('#addProjectModal').modal('hide');
        }
      });
    });
  });

  function openSheet(id) {
    document.getElementById('sheetProjectId').innerText = id;
    new bootstrap.Modal(document.getElementById('sheetModal')).show();
  }
</script>
</body>
</html>
