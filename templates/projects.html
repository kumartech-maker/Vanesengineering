<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projects | Ducting ERP</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f9f9f9; font-family: 'Segoe UI', sans-serif; }
    .modal-header { background-color: #007bff; color: white; }
    .modal-footer button { min-width: 100px; }
    .table-responsive { max-height: 500px; overflow-y: auto; }
    .readonly-input { background-color: #f2f2f2; border: 1px solid #ccc; }
    .toast-container { position: fixed; top: 1rem; right: 1rem; z-index: 9999; }
    .sticky-top { position: sticky; top: 0; background-color: #fff; z-index: 10; }
  </style>
</head>
<body>
<div class="container py-4">

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="toast-container">
        {% for category, message in messages %}
          <div class="toast align-items-center text-white bg-{{ 'success' if category == 'success' else 'danger' }} border-0 show mb-2" role="alert">
            <div class="d-flex">
              <div class="toast-body">{{ message }}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <h2 class="mb-4 text-primary">üìÅ Project Management</h2>

  <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addProjectModal">
    ‚ûï Add New Project
  </button>

  <!-- Add Project Modal -->
  <div class="modal fade" id="addProjectModal" tabindex="-1" aria-labelledby="addProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form method="POST" action="/create_project" enctype="multipart/form-data">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title" id="addProjectModalLabel">‚ûï Add New Project</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body row g-3">
            <div class="col-md-6">
              <label>Project Name</label>
              <input name="project_name" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label>Enquiry No</label>
              <input name="enquiry_no" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label>Start Date</label>
              <input name="start_date" type="date" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label>End Date</label>
              <input name="end_date" type="date" class="form-control" required>
            </div>
            <div class="col-md-12">
              <label>Vendor</label>
              <select name="vendor_id" class="form-select" id="vendorSelect" required>
                <option value="">-- Select Vendor --</option>
                {% for vendor in vendors %}
                <option value="{{ vendor.id }}" data-gst="{{ vendor.gst }}" data-address="{{ vendor.address }}">
                  {{ vendor.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label>Vendor GST</label>
              <input type="text" class="form-control" id="vendorGst" readonly>
            </div>
            <div class="col-md-6">
              <label>Vendor Address</label>
              <input type="text" class="form-control" id="vendorAddress" readonly>
            </div>
            <div class="col-md-12">
              <label>Drawing File (Optional)</label>
              <input type="file" name="drawing_file" class="form-control">
            </div>
            <div class="col-md-12">
              <label>Notes</label>
              <textarea name="notes" class="form-control" rows="2"></textarea>
            </div>
            <div class="col-md-12">
              <label>Incharge</label>
              <input name="incharge" class="form-control" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">‚úÖ Create</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Duct Entry Modal -->
  {% if edit_entry %}
  <div class="modal fade show" id="editDuctModal" tabindex="-1" style="display:block;" aria-modal="true" role="dialog">
    <div class="modal-dialog modal-lg">
      <form method="POST" action="/edit_duct/{{ edit_entry.id }}">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title">‚úèÔ∏è Edit Duct Entry</h5>
            <a href="/project/{{ project.id }}" class="btn-close"></a>
          </div>
          <div class="modal-body row g-3">
            <input type="hidden" name="project_id" value="{{ project.id }}">
            <div class="col-md-6">
              <label>Duct No</label>
              <input name="duct_no" class="form-control" value="{{ edit_entry.duct_no }}" required>
            </div>
            <div class="col-md-6">
              <label>Type</label>
              <select name="duct_type" class="form-select" id="ductTypeModal" required>
                {% set types = ['ST', 'RED', 'OFFSET', 'SHOE', 'ELB', 'VANES', 'DUM'] %}
                {% for type in types %}
                <option value="{{ type }}" {% if edit_entry.duct_type == type %}selected{% endif %}>{{ type }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label>W1</label>
              <input name="width1" type="number" step="any" class="form-control" value="{{ edit_entry.width1 }}" required>
            </div>
            <div class="col-md-6">
              <label>H1</label>
              <input name="height1" type="number" step="any" class="form-control" value="{{ edit_entry.height1 }}" required>
            </div>
            <div class="col-md-6">
              <label>W2</label>
              <input name="width2" type="number" step="any" class="form-control" value="{{ edit_entry.width2 }}">
            </div>
            <div class="col-md-6">
              <label>H2</label>
              <input name="height2" type="number" step="any" class="form-control" value="{{ edit_entry.height2 }}">
            </div>
            <div class="col-md-6">
              <label>Qty</label>
              <input name="quantity" type="number" step="1" class="form-control" value="{{ edit_entry.quantity }}" required>
            </div>
            <div class="col-md-6">
              <label>Length/Radius</label>
              <input name="length_or_radius" type="number" step="any" class="form-control" value="{{ edit_entry.length_or_radius }}" required>
            </div>
            <div class="col-md-6">
              <label>Deg/Offset</label>
              <input name="degree_or_offset" type="number" step="any" class="form-control" value="{{ edit_entry.degree_or_offset }}">
            </div>
            <div class="col-md-6 factor-field-modal d-none">
              <label>Factor</label>
              <input name="factor" id="factorModal" type="number" step="0.01" class="form-control" value="{{ edit_entry.factor or 1.0 }}">
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-warning">üíæ Update</button>
            <a href="/project/{{ project.id }}" class="btn btn-secondary">‚ùå Cancel</a>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endif %}

  <!-- Project Table -->
  <div class="table-responsive mb-4">
    <table class="table table-bordered table-hover bg-white">
      <thead class="table-light">
        <tr>
          <th>Project Name</th>
          <th>Vendor</th>
          <th>Enquiry No</th>
          <th>Start</th>
          <th>End</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for project in projects %}
        <tr>
          <td>{{ project.project_name }}</td>
          <td>{{ project.vendor_name }}</td>
          <td>{{ project.enquiry_no }}</td>
          <td>{{ project.start_date }}</td>
          <td>{{ project.end_date }}</td>
          <td>{{ project.status }}</td>
          <td>
            <a href="/project/{{ project.id }}" class="btn btn-sm btn-info">Open</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if project %}
  <!-- Selected Project Info -->
  <div class="row bg-light p-3 rounded mb-3 border">
    <div class="col-md-3"><strong>üìÅ Project:</strong> {{ project.project_name }}</div>
    <div class="col-md-3"><strong>üè∑ Enquiry:</strong> {{ project.enquiry_no }}</div>
    <div class="col-md-3"><strong>üìÖ Start:</strong> {{ project.start_date }}</div>
    <div class="col-md-3"><strong>üìÖ End:</strong> {{ project.end_date }}</div>
  </div>

  <!-- Project Action Buttons -->
  <div class="d-flex gap-2 mb-3 flex-wrap">
    {% if project.status == 'new' %}
    <form method="POST" action="/continue_to_measurement/{{ project.id }}">
      <button type="submit" class="btn btn-warning">üìã Save & Continue to Measurement Sheet</button>
    </form>
    {% endif %}

    {% if project.status == 'preparation' %}
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#measurementSheetModal">
      üìê Measurement Sheet
    </button>
    {% endif %}

    <form method="POST" action="/submit_for_review/{{ project.id }}">
      <button class="btn btn-secondary">üöß Submit for Review</button>
    </form>
  </div>

  <!-- Duct Entry Form and Duct Entries Table -->
  <div class="row">
    <div class="col-md-5">
      <form method="POST" action="/add_duct">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <div class="card shadow-sm mb-3">
          <div class="card-header bg-primary text-white">‚ûï Duct Entry</div>
          <div class="card-body row g-2">

            <div class="col-md-6">
              <label>Duct No</label>
              <input name="duct_no" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label>Type</label>
              <select name="duct_type" id="ductType" class="form-select" required>
                <option value="">-- Select Type --</option>
                <option value="ST">ST</option>
                <option value="RED">RED</option>
                <option value="OFFSET">OFFSET</option>
                <option value="SHOE">SHOE</option>
                <option value="ELB">ELB</option>
                <option value="VANES">VANES</option>
                <option value="DUM">DUM</option>
              </select>
            </div>

            <div class="col-md-6">
              <label>W1</label>
              <input name="width1" id="width1" type="number" step="any" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label>H1</label>
              <input name="height1" id="height1" type="number" step="any" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label>W2</label>
              <input name="width2" id="width2" type="number" step="any" class="form-control">
            </div>
            <div class="col-md-6">
              <label>H2</label>
              <input name="height2" id="height2" type="number" step="any" class="form-control">
            </div>

            <div class="col-md-6">
              <label>Qty</label>
              <input name="quantity" id="quantity" type="number" step="1" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label>Length/Radius</label>
              <input name="length_or_radius" id="length_or_radius" type="number" step="any" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label>Deg/Offset</label>
              <input name="degree_or_offset" id="degree_or_offset" type="number" step="any" class="form-control">
            </div>

            <div class="col-md-6 factor-field d-none">
              <label>Factor</label>
              <input name="factor" id="factor" type="number" step="0.01" class="form-control" value="1.0">
            </div>

          </div>
          <div class="card-footer text-end">
            <button type="submit" class="btn btn-success">‚ûï Add Entry</button>
          </div>
        </div>
      </form>
    </div>

    <div class="col-md-7">
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">üìä Duct Entries</div>
        <div class="card-body table-responsive p-0" style="max-height: 520px; overflow-y: auto;">
          <table class="table table-sm table-striped m-0">
            <thead class="table-light sticky-top">
              <tr>
                <th>Duct</th><th>Type</th><th>W1</th><th>H1</th><th>W2</th><th>H2</th>
                <th>Qty</th><th>Len</th><th>Deg</th><th>Factor</th>
                <th>Gauge</th><th>Area</th><th>Nuts</th><th>Cleat</th><th>Gasket</th><th>Corner</th><th>Weight</th><th>üõ†</th>
              </tr>
            </thead>
            <tbody>
              {% set total_area = 0 %}
              {% set total_nuts = 0 %}
              {% set total_cleat = 0 %}
              {% set total_gasket = 0 %}
              {% set total_corner = 0 %}
              {% set total_weight = 0 %}
              {% for entry in ducts %}
              <tr>
                <td>{{ entry.duct_no }}</td>
                <td>{{ entry.duct_type }}</td>
                <td>{{ entry.width1 }}</td>
                <td>{{ entry.height1 }}</td>
                <td>{{ entry.width2 }}</td>
                <td>{{ entry.height2 }}</td>
                <td>{{ entry.quantity }}</td>
                <td>{{ entry.length_or_radius }}</td>
                <td>{{ entry.degree_or_offset }}</td>
                <td>{{ entry.factor }}</td>
                <td>{{ entry.gauge }}</td>
                <td>{{ "%.2f"|format(entry.area|float) }}</td>
                <td>{{ "%.2f"|format(entry.nuts_bolts|float) }}</td>
                <td>{{ "%.2f"|format(entry.cleat|float) }}</td>
                <td>{{ "%.2f"|format(entry.gasket|float) }}</td>
                <td>{{ "%.2f"|format(entry.corner_pieces|float) }}</td>
                <td>{{ "%.2f"|format(entry.weight|float) }}</td>
                <td>
                  <button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editDuctModal{{ entry.id }}">‚úèÔ∏è</button>
                  <form action="{{ url_for('delete_duct', entry_id=entry.id) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?');">üóëÔ∏è</button>
                  </form>
                </td>
              </tr>
              {% set total_area = total_area + (entry.area|float) %}
              {% set total_nuts = total_nuts + (entry.nuts_bolts|float) %}
              {% set total_cleat = total_cleat + (entry.cleat|float) %}
              {% set total_gasket = total_gasket + (entry.gasket|float) %}
              {% set total_corner = total_corner + (entry.corner_pieces|float) %}
              {% set total_weight = total_weight + (entry.weight|float) %}
              {% endfor %}
            </tbody>
            <tfoot class="table-light fw-bold">
              <tr>
                <td colspan="11" class="text-end">TOTAL:</td>
                <td>{{ "%.2f"|format(total_area) }}</td>
                <td>{{ "%.2f"|format(total_nuts) }}</td>
                <td>{{ "%.2f"|format(total_cleat) }}</td>
                <td>{{ "%.2f"|format(total_gasket) }}</td>
                <td>{{ "%.2f"|format(total_corner) }}</td>
                <td>{{ "%.2f"|format(total_weight) }}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      </div>
    </div>
  </div> <!-- End row -->

<!-- Edit Duct Entry Modals -->
  {% for entry in ducts %}
  <div class="modal fade" id="editDuctModal{{ entry.id }}" tabindex="-1" aria-labelledby="editDuctLabel{{ entry.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form method="POST" action="{{ url_for('edit_duct', entry_id=entry.id) }}">
        <input type="hidden" name="project_id" value="{{ project.id }}">
        <div class="modal-content">
          <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title" id="editDuctLabel{{ entry.id }}">‚úèÔ∏è Edit Duct Entry</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body row g-2">

            <div class="col-md-6">
              <label>Duct No</label>
              <input name="duct_no" class="form-control" value="{{ entry.duct_no }}" required>
            </div>
            <div class="col-md-6">
              <label>Type</label>
              <select name="duct_type" id="ductTypeModal" class="form-select" required>
                {% set types = ['ST', 'RED', 'OFFSET', 'SHOE', 'ELB', 'VANES', 'DUM'] %}
                {% for t in types %}
                <option value="{{ t }}" {% if entry.duct_type == t %}selected{% endif %}>{{ t }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-6">
              <label>W1</label>
              <input name="width1" type="number" step="any" class="form-control" value="{{ entry.width1 }}" required>
            </div>
            <div class="col-md-6">
              <label>H1</label>
              <input name="height1" type="number" step="any" class="form-control" value="{{ entry.height1 }}" required>
            </div>

            <div class="col-md-6">
              <label>W2</label>
              <input name="width2" type="number" step="any" class="form-control" value="{{ entry.width2 }}">
            </div>
            <div class="col-md-6">
              <label>H2</label>
              <input name="height2" type="number" step="any" class="form-control" value="{{ entry.height2 }}">
            </div>

            <div class="col-md-6">
              <label>Qty</label>
              <input name="quantity" type="number" step="1" class="form-control" value="{{ entry.quantity }}" required>
            </div>
            <div class="col-md-6">
              <label>Length/Radius</label>
              <input name="length_or_radius" type="number" step="any" class="form-control" value="{{ entry.length_or_radius }}" required>
            </div>

            <div class="col-md-6">
              <label>Deg/Offset</label>
              <input name="degree_or_offset" type="number" step="any" class="form-control" value="{{ entry.degree_or_offset }}">
            </div>

            <div class="col-md-6 factor-field-modal {% if entry.duct_type not in ['RED', 'OFFSET', 'SHOE', 'ELB'] %}d-none{% endif %}">
              <label>Factor</label>
              <input name="factor" type="number" step="0.01" class="form-control" value="{{ entry.factor or 1.0 }}">
            </div>

          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-warning">üíæ Update</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå Cancel</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  {% endfor %}

  <!-- Final Action Buttons -->
  <div class="mt-3 d-flex flex-wrap gap-2">
    <a href="/export_excel/{{ project.id }}" class="btn btn-outline-primary">üì§ Export Excel</a>
    <a href="/export_pdf/{{ project.id }}" class="btn btn-outline-secondary">üßæ Export PDF</a>
    <button onclick="window.print()" class="btn btn-outline-dark">üñ®Ô∏è Print</button>
    <form method="POST" action="/submit_all/{{ project.id }}">
      <button class="btn btn-success">üì® Submit All & Move to Production</button>
    </form>
  </div>
{% endif %}
</div> <!-- End container -->
  
<!-- Auto Calculation Script -->
<script>
function setupAutoCalculation(prefix = '') {
  const get = (id) => parseFloat(document.getElementById(prefix + id)?.value || 0);
  const set = (id, val) => {
    const el = document.getElementById(prefix + id);
    if (el) el.value = val;
  };

  function calculate() {
    const type = (document.getElementById(prefix + 'ductType')?.value || '').toUpperCase();
    const w1 = get('width1'), h1 = get('height1'), w2 = get('width2'), h2 = get('height2');
    const len = get('length_or_radius'), qty = get('quantity'), deg = get('degree_or_offset');
    const factor = get('factor') || 1;

    let area = 0;
    if (type === 'ST') {
      area = 2 * (w1 + h1) / 1000 * (len / 1000) * qty;
    } else if (type === 'RED') {
      area = (w1 + h1 + w2 + h2) / 1000 * (len / 1000) * qty * factor;
    } else if (type === 'DUM') {
      area = (w1 * h1) / 1000000 * qty;
    } else if (type === 'OFFSET') {
      area = (w1 + h1 + w2 + h2) / 1000 * ((len + deg) / 1000) * qty * factor;
    } else if (type === 'SHOE') {
      area = (w1 + h1) * 2 / 1000 * (len / 1000) * qty * factor;
    } else if (type === 'VANES') {
      area = w1 / 1000 * (2 * Math.PI * (w1 / 1000) / 4) * qty;
    } else if (type === 'ELB') {
      area = 2 * (w1 + h1) / 1000 * ((h1 / 2 / 1000) + (len / 1000) * (Math.PI * (deg / 180))) * qty * factor;
    }

    set('area', area.toFixed(2));

    let gauge = '18g';
    if (w1 <= 751 && h1 <= 751) gauge = '24g';
    else if (w1 <= 1201 && h1 <= 1201) gauge = '22g';
    else if (w1 <= 1800 && h1 <= 1800) gauge = '20g';
    set('gauge', gauge);

    set('nuts_bolts', (qty * 4).toFixed(2));

    let cleat = 12;
    if (gauge === '24g') cleat = 4;
    else if (gauge === '22g') cleat = 8;
    else if (gauge === '20g') cleat = 10;
    set('cleat', (qty * cleat).toFixed(2));

    const gasket = (w1 + h1 + w2 + h2) / 1000 * qty;
    set('gasket', gasket.toFixed(2));

    const corners = (type === 'DUM') ? 0 : qty * 8;
    set('corner_pieces', corners.toFixed(2));
  }

  const fields = ['ductType', 'width1', 'height1', 'width2', 'height2', 'length_or_radius', 'quantity', 'degree_or_offset', 'factor'];
  fields.forEach(id => {
    const el = document.getElementById(prefix + id);
    if (el) el.addEventListener('input', calculate);
  });

  calculate();
}

function setupFactorField(typeId, fieldClass) {
  const ductTypeSelect = document.getElementById(typeId);
  const factorField = document.querySelector(fieldClass);

  function update() {
    const value = ductTypeSelect?.value;
    const show = ['RED', 'OFFSET', 'SHOE', 'ELB'].includes(value);
    if (show) factorField?.classList.remove('d-none');
    else factorField?.classList.add('d-none');
  }

  if (ductTypeSelect) {
    ductTypeSelect.addEventListener('change', update);
    update();
  }
}

function setupVendorAutoFill() {
  const vendorSelect = document.getElementById('vendorSelect');
  const gstInput = document.getElementById('vendorGst');
  const addrInput = document.getElementById('vendorAddress');

  if (vendorSelect && gstInput && addrInput) {
    vendorSelect.addEventListener('change', function () {
      const selected = this.options[this.selectedIndex];
      const gst = selected.getAttribute('data-gst') || '';
      const addr = selected.getAttribute('data-address') || '';
      gstInput.value = gst;
      addrInput.value = addr;
    });
  }
}

document.addEventListener('DOMContentLoaded', function () {
  setupAutoCalculation('');
  setupAutoCalculation('Modal'); // for edit modal
  setupFactorField('ductType', '.factor-field');
  setupFactorField('ductTypeModal', '.factor-field-modal');
  setupVendorAutoFill();
});
</script>

  <!-- Bootstrap & jQuery JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</body>
</html>
  
