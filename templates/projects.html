<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Projects</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css" rel="stylesheet">
  <style>
    .table td, .table th { vertical-align: middle; }
  </style>
</head>
<body>
<div class="container mt-4">
  <h3>Projects <button class="btn btn-primary btn-sm float-end" data-bs-toggle="modal" data-bs-target="#addProjectModal">+ Add Project</button></h3>
  <table class="table table-bordered mt-3" id="projectsTable">
    <thead class="table-secondary">
      <tr>
        <th>ID</th>
        <th>Enquiry ID</th>
        <th>Name</th>
        <th>Vendor</th>
        <th>Location</th>
        <th>Start</th>
        <th>End</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for p in projects %}
      <tr>
        <td>{{ p.id }}</td>
        <td>{{ p.enquiry_id }}</td>
        <td>{{ p.project_name }}</td>
        <td>{{ p.vendor_name }}</td>
        <td>{{ p.location }}</td>
        <td>{{ p.start_date }}</td>
        <td>{{ p.end_date }}</td>
        <td>
          <button class="btn btn-sm btn-info" onclick="openSheet({{ p.id }})">Sheet</button>
          <button class="btn btn-sm btn-warning">Edit</button>
          <button class="btn btn-sm btn-danger">Delete</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Add Project Modal -->
<div class="modal fade" id="addProjectModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" id="projectForm">
      <div class="modal-header"><h5 class="modal-title">Add Project</h5></div>
      <div class="modal-body">
        <div class="mb-2">
          <label>Enquiry ID</label>
          <input type="text" class="form-control" value="{{ new_enquiry_id }}" readonly>
        </div>
        <div class="mb-2">
          <label>Project Name</label>
          <input type="text" name="project_name" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Quotation/RO</label>
          <input type="text" name="quotation_ro" class="form-control">
        </div>
        <div class="mb-2">
          <label>Vendor</label>
          <select name="vendor_id" class="selectpicker form-control" id="vendorDropdown" data-live-search="true" required>
            <option value="" disabled selected>Select Vendor</option>
            {% for v in vendors %}
              <option value="{{ v.id }}" data-gst="{{ v.gst_number }}" data-address="{{ v.address }}">{{ v.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-2">
          <label>GST Number</label>
          <input type="text" id="vendorGST" class="form-control" readonly>
        </div>
        <div class="mb-2">
          <label>Address</label>
          <textarea id="vendorAddress" class="form-control" rows="2" readonly></textarea>
        </div>
        <div class="mb-2"><label>Location</label><input type="text" name="location" class="form-control"></div>
        <div class="mb-2"><label>Start Date</label><input type="date" name="start_date" class="form-control"></div>
        <div class="mb-2"><label>End Date</label><input type="date" name="end_date" class="form-control"></div>
        <div class="mb-2"><label>Incharge</label><input type="text" name="incharge" class="form-control"></div>
        <div class="mb-2"><label>Contact Number</label><input type="text" name="contact_number" class="form-control"></div>
        <div class="mb-2"><label>Email</label><input type="email" name="email" class="form-control"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-success">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Sheet Modal -->
<div class="modal fade" id="sheetModal" tabindex="-1">
  <div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Measurement Sheet - Project ID <span id="sheetProjectId"></span></h5></div>
    <div class="modal-body">Measurement sheet details here...</div>
  </div></div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="toast-success" class="toast align-items-center text-bg-success border-0">
    <div class="d-flex">
      <div class="toast-body">Project saved successfully!</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
<script>
  $(document).ready(function () {
    $('.selectpicker').selectpicker();

    $('#vendorDropdown').on('changed.bs.select', function () {
      const selected = $(this).find('option:selected');
      $('#vendorGST').val(selected.data('gst') || '');
      $('#vendorAddress').val(selected.data('address') || '');
    });

    $('#projectForm').on('submit', function (e) {
      e.preventDefault();
      $.post('/create_project', $(this).serialize(), function (res) {
        if (res.status === 'success') {
          const p = res.project;
          const row = `<tr>
            <td>${p.id}</td>
            <td>${p.enquiry_id}</td>
            <td>${p.project_name}</td>
            <td>${p.vendor_name}</td>
            <td>${p.location}</td>
            <td>${p.start_date}</td>
            <td>${p.end_date}</td>
            <td>
              <button class="btn btn-sm btn-info" onclick="openSheet(${p.id})">Sheet</button>
              <button class="btn btn-sm btn-warning">Edit</button>
              <button class="btn btn-sm btn-danger">Delete</button>
            </td></tr>`;
          $('#projectsTable tbody').prepend(row);
          new bootstrap.Modal('#addProjectModal').hide;
          bootstrap.Toast.getOrCreateInstance(document.getElementById('toast-success')).show();
          $('#addProjectModal').modal('hide');
          $('#projectForm')[0].reset();
          $('.selectpicker').selectpicker('refresh');
        }
      });
    });
  });

  function openSheet(id) {
    document.getElementById('sheetProjectId').innerText = id;
    new bootstrap.Modal(document.getElementById('sheetModal')).show();
  }
</script>
</body>
</html>
