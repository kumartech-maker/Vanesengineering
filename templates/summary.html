<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Summary Report</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="p-4">
  <h2 class="mb-4">Project Summary</h2>

  <form method="post" enctype="multipart/form-data" class="row g-3 mb-4">
    <div class="col-md-3">
      <input type="file" name="mdSignature" class="form-control" required>
      <label class="form-label">Managing Director Signature</label>
    </div>
    <div class="col-md-3">
      <input type="file" name="pmSignature" class="form-control" required>
      <label class="form-label">Project Manager Signature</label>
    </div>
    <div class="col-md-3 align-self-end">
      <button class="btn btn-primary">Export to PDF</button>
    </div>
  </form>

  <div class="row mb-3">
    <div class="col-md-6">
      <input type="text" id="searchInput" class="form-control" placeholder="Search by Project or Site...">
    </div>
    <div class="col-md-4">
      <select id="stageFilter" class="form-select">
        <option value="">Filter by Stage</option>
        <option>Sheet Cutting</option>
        <option>Boxing</option>
        <option>Assembly</option>
        <option>Dispatch</option>
      </select>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered table-striped" id="summaryTable">
      <thead class="table-dark">
        <tr>
          <th>Project</th>
          <th>Site</th>
          <th>Stage</th>
          <th>Area (sq.m)</th>
          <th>Progress (%)</th>
        </tr>
      </thead>
      <tbody>
        {% for row in data %}
        <tr>
          <td>{{ row.project }}</td>
          <td>{{ row.site }}</td>
          <td>{{ row.stage }}</td>
          <td>{{ row.area }}</td>
          <td>{{ row.progress }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <hr class="my-4">

  <div class="row">
    <div class="col-md-6">
      <canvas id="progressChart"></canvas>
    </div>
    <div class="col-md-6">
      <canvas id="areaChart"></canvas>
    </div>
  </div>

  <script>
    const searchInput = document.getElementById('searchInput');
    const stageFilter = document.getElementById('stageFilter');
    const tableRows = document.querySelectorAll("#summaryTable tbody tr");

    function filterTable() {
      const searchText = searchInput.value.toLowerCase();
      const stage = stageFilter.value;

      tableRows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        const matchesSearch = cells[0].innerText.toLowerCase().includes(searchText) ||
                              cells[1].innerText.toLowerCase().includes(searchText);
        const matchesStage = !stage || cells[2].innerText === stage;

        row.style.display = (matchesSearch && matchesStage) ? "" : "none";
      });
    }

    searchInput.addEventListener("keyup", filterTable);
    stageFilter.addEventListener("change", filterTable);

    // Charts (example with dummy data, replace with backend if needed)
    const ctx1 = document.getElementById('progressChart').getContext('2d');
    const ctx2 = document.getElementById('areaChart').getContext('2d');

    const labels = {{ data|map(attribute='project')|unique|list|tojson }};
    const progressData = {};
    const areaData = {};

    {% for row in data %}
      const key = "{{ row.project }}";
      if (!progressData[key]) progressData[key] = 0;
      if (!areaData[key]) areaData[key] = 0;
      progressData[key] += {{ row.progress }};
      areaData[key] += {{ row.area }};
    {% endfor %}

    const progressChart = new Chart(ctx1, {
      type: 'bar',
      data: {
        labels: Object.keys(progressData),
        datasets: [{
          label: 'Total Progress (%)',
          data: Object.values(progressData),
          backgroundColor: 'rgba(54, 162, 235, 0.6)',
        }]
      },
      options: { responsive: true, plugins: { title: { display: true, text: 'Project Progress' } } }
    });

    const areaChart = new Chart(ctx2, {
      type: 'pie',
      data: {
        labels: Object.keys(areaData),
        datasets: [{
          label: 'Total Area',
          data: Object.values(areaData),
          backgroundColor: ['#36A2EB', '#FFCE56', '#FF6384', '#8BC34A'],
        }]
      },
      options: { responsive: true, plugins: { title: { display: true, text: 'Area per Project' } } }
    });
  </script>
</body>
</html>
