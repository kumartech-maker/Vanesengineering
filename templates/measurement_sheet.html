<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Measurement Sheet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    input[type=number] {
      width: 80px;
    }
    .table th, .table td {
      vertical-align: middle;
      text-align: center;
    }
  </style>
</head>
<body class="bg-light">
<div class="container mt-4">
  <h3 class="text-center mb-4">Measurement Sheet - {{ project.project_name }}</h3>
  <form method="POST" action="/measurement_sheet/{{ project.id }}">
    <input type="hidden" name="project_id" value="{{ project.id }}">
    <div class="row">

      <!-- Left: Entry Table -->
      <div class="col-md-8">
        <table class="table table-bordered" id="sheet_table">
          <thead class="table-secondary">
            <tr>
              <th>Duct No</th><th>Type</th><th>W1</th><th>H1</th><th>W2</th><th>H2</th>
              <th>Qty</th><th>Length</th><th>Deg</th><th>Factor</th><th>Action</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td><input type="text" name="duct_no[]" class="form-control"></td>
              <td>
                <select name="duct_type[]" class="form-select type">
                  <option value="ST">Straight</option>
                  <option value="ELB">Elbow</option>
                  <option value="OFFSET">Offset</option>
                  <option value="RED">Transition</option>
                  <option value="DUM">Dummy</option>
                  <option value="SHOE">Shoe</option>
                  <option value="VANES">Vanes</option>
                </select>
              </td>
              <td><input type="number" name="w1[]" class="form-control w1" step="0.01"></td>
              <td><input type="number" name="h1[]" class="form-control h1" step="0.01"></td>
              <td><input type="number" name="w2[]" class="form-control w2" step="0.01"></td>
              <td><input type="number" name="h2[]" class="form-control h2" step="0.01"></td>
              <td><input type="number" name="qty[]" class="form-control qty" value="1"></td>
              <td><input type="number" name="length[]" class="form-control len" step="0.01"></td>
              <td><input type="number" name="deg[]" class="form-control deg" step="0.01"></td>
              <td><input type="number" name="factor[]" class="form-control factor" value="1"></td>
              <td><button type="button" class="btn btn-sm btn-danger" onclick="removeRow(this)">X</button></td>
            </tr>
          </tbody>
        </table>
        <button type="button" class="btn btn-secondary" onclick="addRow()">+ Add Row</button>
        <button type="submit" class="btn btn-primary float-end">Save Sheet</button>
      </div>

      <!-- Right: Totals -->
      <div class="col-md-4">
        <table class="table table-bordered text-center">
          <thead class="table-dark">
            <tr><th colspan="2">Total Area by Gauge</th></tr>
          </thead>
          <tbody>
            <tr><th>24G</th><td id="total_24g_area">0.00</td></tr>
            <tr><th>22G</th><td id="total_22g_area">0.00</td></tr>
            <tr><th>20G</th><td id="total_20g_area">0.00</td></tr>
            <tr><th>18G</th><td id="total_18g_area">0.00</td></tr>
          </tbody>
        </table>
        <table class="table table-bordered text-center mt-3">
          <thead class="table-dark"><tr><th colspan="2">Materials Summary</th></tr></thead>
          <tbody>
            <tr><th>Nuts & Bolts</th><td id="total_nuts">0</td></tr>
            <tr><th>Cleats</th><td id="total_cleat">0</td></tr>
            <tr><th>Gasket (m)</th><td id="total_gasket">0.00</td></tr>
            <tr><th>Corner Pieces</th><td id="total_corner">0</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </form>
</div>

<!-- Scripts -->
<script>
function addRow() {
  const row = document.querySelector('#tableBody tr').cloneNode(true);
  row.querySelectorAll('input').forEach(input => input.value = '');
  document.querySelector('#tableBody').appendChild(row);
}

function removeRow(btn) {
  const rows = document.querySelectorAll('#tableBody tr');
  if (rows.length > 1) btn.closest('tr').remove();
}

function calculateRow(row) {
  const get = cls => parseFloat(row.querySelector('.' + cls)?.value) || 0;
  const type = row.querySelector('.type')?.value;
  const w1 = get('w1'), h1 = get('h1'), w2 = get('w2'), h2 = get('h2');
  const qty = get('qty'), len = get('len'), deg = get('deg'), factor = get('factor');
  let area = 0;

  if (type === 'ST') area = 2 * (w1 + h1) * len * qty;
  else if (type === 'RED') area = (w1 + h1 + w2 + h2) * len * qty * factor;
  else if (type === 'DUM') area = (w1 * h1) * qty;
  else if (type === 'OFFSET') area = (w1 + h1 + w2 + h2) * (len + deg) * qty * factor;
  else if (type === 'SHOE') area = (w1 + h1) * 2 * len * qty * factor;
  else if (type === 'VANES') area = w1 * (2 * Math.PI * (w1 / 4)) * qty;
  else if (type === 'ELB') area = 2 * (w1 + h1) * ((h1 / 2) + (len * (Math.PI * (deg / 180)))) * qty * factor;

  area = area / 1000000; // convert to mÂ²

  let gauge = '18g';
  if (w1 <= 751 && h1 <= 751) gauge = '24g';
  else if (w1 <= 1201 && h1 <= 1201) gauge = '22g';
  else if (w1 <= 1800 && h1 <= 1800) gauge = '20g';

  const nuts = qty * 4;
  const cleat = qty * { '24g': 4, '22g': 8, '20g': 10 }[gauge] || 12;
  const gasket = (w1 + h1 + w2 + h2) / 1000 * qty;
  const corner = type === 'DUM' ? 0 : qty * 8;

  return { gauge, area, nuts, cleat, gasket, corner };
}

function updateTotals() {
  const rows = document.querySelectorAll('#tableBody tr');
  const gauges = { '24g': 0, '22g': 0, '20g': 0, '18g': 0 };
  let nuts = 0, cleat = 0, gasket = 0, corner = 0;

  rows.forEach(row => {
    const data = calculateRow(row);
    gauges[data.gauge] += data.area;
    nuts += data.nuts;
    cleat += data.cleat;
    gasket += data.gasket;
    corner += data.corner;
  });

  document.getElementById('total_24g_area').textContent = gauges['24g'].toFixed(2);
  document.getElementById('total_22g_area').textContent = gauges['22g'].toFixed(2);
  document.getElementById('total_20g_area').textContent = gauges['20g'].toFixed(2);
  document.getElementById('total_18g_area').textContent = gauges['18g'].toFixed(2);
  document.getElementById('total_nuts').textContent = nuts;
  document.getElementById('total_cleat').textContent = cleat;
  document.getElementById('total_gasket').textContent = gasket.toFixed(2);
  document.getElementById('total_corner').textContent = corner;
}

document.addEventListener('input', function (e) {
  if (e.target.closest('tr')) updateTotals();
});
window.onload = updateTotals;
</script>
</body>
  </html>
