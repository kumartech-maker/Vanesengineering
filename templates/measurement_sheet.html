<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Measurement Sheet</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .form-section {
      background: #f9f9f9;
      border-radius: 10px;
      padding: 20px;
    }
    .table-section {
      overflow-x: auto;
    }
    th, td {
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">Project: {{ project.project_name }}</h3>
      <a href="/projects" class="btn btn-outline-secondary">‚Üê Back to Projects</a>
    </div>

    <div class="row">
      <div class="col-md-4 form-section">
        <form id="ductForm">
          <div class="mb-2">
            <label>Duct No</label>
            <input type="text" class="form-control" name="duct_no" required />
          </div>
          <div class="mb-2">
            <label>Type</label>
            <select class="form-control" name="duct_type" required>
              <option value="">Select Type</option>
              <option>Straight</option>
              <option>Elbow</option>
              <option>Offset</option>
              <option>Transition</option>
              <option>Round</option>
              <option>Square</option>
            </select>
          </div>
          <div class="mb-2">
            <label>Width 1</label>
            <input type="number" class="form-control" name="w1" required />
          </div>
          <div class="mb-2">
            <label>Height 1</label>
            <input type="number" class="form-control" name="h1" required />
          </div>
          <div class="mb-2">
            <label>Width 2</label>
            <input type="number" class="form-control" name="w2" />
          </div>
          <div class="mb-2">
            <label>Height 2</label>
            <input type="number" class="form-control" name="h2" />
          </div>
          <div class="mb-2">
            <label>Quantity</label>
            <input type="number" class="form-control" name="qty" required />
          </div>
          <div class="mb-2">
            <label>Length / Radius</label>
            <input type="number" class="form-control" name="length" />
          </div>
          <div class="mb-2">
            <label>Degree / Offset</label>
            <input type="number" class="form-control" name="deg" />
          </div>
          <div class="mb-2">
            <label>Factor</label>
            <input type="number" class="form-control" name="factor" value="1" />
          </div>
          <div class="mt-3 d-grid">
            <button type="submit" class="btn btn-success">‚ûï Add Duct</button>
          </div>
        </form>
      </div>

      <div class="col-md-8 table-section">
        <table class="table table-bordered table-striped text-center" id="ductTable">
          <thead class="table-dark">
            <tr>
              <th>Duct</th>
              <th>Type</th>
              <th>W1</th>
              <th>H1</th>
              <th>W2</th>
              <th>H2</th>
              <th>Qty</th>
              <th>Len</th>
              <th>Deg</th>
              <th>Factor</th>
              <th>Gauge</th>
              <th>Area</th>
              <th>24G</th>
              <th>22G</th>
              <th>20G</th>
              <th>18G</th>
              <th>Nuts</th>
              <th>Cleat</th>
              <th>Gasket</th>
              <th>Corner</th>
              <th>üõ†</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
          <tfoot>
  <tr class="table-light fw-bold">
    <td colspan="11" class="text-end">Totals:</td>
    <td id="totalArea">0</td>
    <td id="total24G">0</td>
    <td id="total22G">0</td>
    <td id="total20G">0</td>
    <td id="total18G">0</td>
    <td id="totalNuts">0</td>
    <td id="totalCleat">0</td>
    <td id="totalGasket">0</td>
    <td id="totalCorner">0</td>
    <td></td>
  </tr>
          </tfoot>
        </table>
        <div class="mt-3 d-flex gap-3">
          <button class="btn btn-success" onclick="exportTableToExcel()">Export to Excel</button>
          <button class="btn btn-primary" onclick="window.print()">Print</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById("ductForm");
    const tableBody = document.getElementById("tableBody");

    form.addEventListener("submit", function (e) {
      e.preventDefault();

      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      const w1 = parseFloat(data.w1) || 0;
      const h1 = parseFloat(data.h1) || 0;
      const w2 = parseFloat(data.w2) || 0;
      const h2 = parseFloat(data.h2) || 0;
      const qty = parseInt(data.qty) || 0;
      const factor = parseFloat(data.factor) || 1;
      const type = data.duct_type;

      // Gauge logic
      let gauge = "24G";
      const maxWH = Math.max(w1, h1);
      if (maxWH > 1000) gauge = "22G";
      if (maxWH > 1500) gauge = "20G";
      if (maxWH > 2000) gauge = "18G";

      // Area logic (basic, customizable per type)
      let area = 0;
      if (type === "Straight" || type === "Square") {
        area = ((w1 + h1) * 2 * (data.length || 1)) / 1e6;
      } else if (type === "Elbow") {
        area = ((w1 + h1) * 2 * 0.785 * (data.deg || 90)) / 1e6;
      } else {
        area = ((w1 + h1 + w2 + h2) * (data.length || 1)) / 2e6;
      }
      area = (area * qty).toFixed(2);

      // Material breakdown
      const nuts = qty * 4;
      const cleat = Math.round(qty * (gauge === "18G" ? 2.5 : 1.5));
      const gasket = (((w1 + h1 + w2 + h2) / 1000) * qty).toFixed(2);
      const corner = type === "Round" ? 0 : qty * 8;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${data.duct_no}</td>
        <td>${data.duct_type}</td>
        <td>${w1}</td>
        <td>${h1}</td>
        <td>${w2}</td>
        <td>${h2}</td>
        <td>${qty}</td>
        <td>${data.length || ""}</td>
        <td>${data.deg || ""}</td>
        <td>${factor}</td>
        <td>${gauge}</td>
        <td>${area}</td>
        <td>${gauge === "24G" ? area : ""}</td>
        <td>${gauge === "22G" ? area : ""}</td>
        <td>${gauge === "20G" ? area : ""}</td>
        <td>${gauge === "18G" ? area : ""}</td>
        <td>${nuts}</td>
        <td>${cleat}</td>
        <td>${gasket}</td>
        <td>${corner}</td>
        <td><button class="btn btn-danger btn-sm" onclick="this.closest('tr').remove()">üóë</button></td>
      `;
      tableBody.appendChild(row);
      form.reset();
      updateTotals();
    });

    function exportTableToExcel() {
      const table = document.getElementById("ductTable");
      const tableHTML = table.outerHTML.replace(/ /g, '%20');
      const filename = 'measurement_sheet.xls';
      const dataType = 'application/vnd.ms-excel';

      const downloadLink = document.createElement("a");
      document.body.appendChild(downloadLink);
      downloadLink.href = 'data:' + dataType + ', ' + tableHTML;
      downloadLink.download = filename;
      downloadLink.click();
      document.body.removeChild(downloadLink);

      function updateTotals() {
  let totalArea = 0, t24 = 0, t22 = 0, t20 = 0, t18 = 0;
  let nuts = 0, cleat = 0, gasket = 0, corner = 0;

  [...tableBody.rows].forEach(row => {
    totalArea += parseFloat(row.cells[11].textContent) || 0;
    t24 += parseFloat(row.cells[12].textContent) || 0;
    t22 += parseFloat(row.cells[13].textContent) || 0;
    t20 += parseFloat(row.cells[14].textContent) || 0;
    t18 += parseFloat(row.cells[15].textContent) || 0;
    nuts += parseFloat(row.cells[16].textContent) || 0;
    cleat += parseFloat(row.cells[17].textContent) || 0;
    gasket += parseFloat(row.cells[18].textContent) || 0;
    corner += parseFloat(row.cells[19].textContent) || 0;
  });

  document.getElementById("totalArea").textContent = totalArea.toFixed(2);
  document.getElementById("total24G").textContent = t24.toFixed(2);
  document.getElementById("total22G").textContent = t22.toFixed(2);
  document.getElementById("total20G").textContent = t20.toFixed(2);
  document.getElementById("total18G").textContent = t18.toFixed(2);
  document.getElementById("totalNuts").textContent = nuts;
  document.getElementById("totalCleat").textContent = cleat;
  document.getElementById("totalGasket").textContent = gasket;
  document.getElementById("totalCorner").textContent = corner;
      }
    }
  </script>
</body>
</html>
